name: Obfuscate master → commit to main

on:
  push:
    branches: [master]          # 只在 master 分支触发
    paths: ['明文源码.js']      # 只有改它才跑
  workflow_dispatch:            # 手动跑

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # 需要写仓库

    steps:
      # 1. 拉 master（默认已拉）
      - name: Checkout master
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. 再拉 main 分支到本地目录 main-branch
      - name: Checkout main
        run: |
          git fetch origin main
          git worktree add main-branch origin/main

      # 3. 装 Node 16
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # 4. 装混淆器
      - name: Install javascript-obfuscator
        run: npm install -g javascript-obfuscator

      # 5. 混淆：master/明文源码.js → main-branch/_worker.js（读取分文件配置）
      - name: Obfuscate
        run: |
          javascript-obfuscator 明文源码.js \
            --output main-branch/_worker.js \
            --config obfuscate.json \
            --seed $RANDOM

      # 6. 提交到 main 分支
      - name: Commit & push main
        run: |
          cd main-branch
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add _worker.js
          git diff --cached --quiet && exit 0
          git checkout -B main origin/main
          git commit -m "chore: obfuscate _worker.js from master"
          git push origin main
